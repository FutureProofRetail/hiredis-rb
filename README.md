# hiredis-rb

Ruby extension that wraps [hiredis](http://github.com/antirez/hiredis) reply
parsing code. It is targeted at speeding up parsing multi bulk replies.

## WARNING

This code is considered beta.

## Install

Install with Rubygems:

    gem install hiredis

## Usage

When you `require "hiredis"`, redis-rb will be automatically loaded and setup
to use hiredis for its connection handling.

### Connection

A connection to Redis can be opened by creating an instance of
`Hiredis::Connection` and calling `#connect`:

    > conn = Hiredis::Connection.new
    > conn.connect("127.0.0.1", 6379)

Commands can be written to Redis by calling `#write` with an array of
arguments. You can call write more than once, resulting in a pipeline of
commands.

    > conn.write ["SET", "speed", "awesome"]
    > conn.write ["GET", "speed"]

After commands are written, use `#read` to receive the subsequent replies.
Make sure **not** to call `#read` more than you have replies to read, or
the connection will block indefinitely. You _can_ use this feature
to implement a subscriber (for Redis Pub/Sub).

    > conn.read
    => "OK"
    > conn.read
    => "awesome"

When the connection was closed by the server, an error of the type
`Hiredis::Connection::EOFError` will be raised. For all I/O related errors,
the Ruby built-in `Errno::*` errors will be raised. All other errors
(such as a protocol error) result in a `RuntimeError`.

### Reply parser

Only using `redis_ext` for the reply parser can be very useful in scenarios
where the I/O is already handled by another component (such as EventMachine).

Use `#feed` on an instance of `Hiredis::Reader` to feed the stream parser with
new data. Use `#read` to get the parsed replies one by one:

    > reader = Hiredis::Reader.new
    > reader.feed("*2\r\n$7\r\nawesome\r\n$5\r\narray\r\n")
    > reader.gets
    => ["awesome", "array"]

## Benchmarks

These numbers were generated by running `benchmark/throughput.rb` against
`ruby 1.8.7 (2010-08-16 patchlevel 302) [i686-darwin10.4.0]`. The benchmark
compares redis-rb using the Ruby socket implementation and Ruby reply parser
against hiredis with C code for both I/O and reply parsing.

For simple line or bulk replies, the throughput improvement is insignificant,
while the larger multi bulk responses will have a noticeable higher throughput.

                                                            user     system      total        real
    redis-rb:  1x PING pipeline, 10000 times            0.310000   0.170000   0.480000 (  0.724149)
     hiredis:  1x PING pipeline, 10000 times            0.220000   0.140000   0.360000 (  0.647922)
    redis-rb: 10x PING pipeline, 10000 times            1.900000   1.060000   2.960000 (  2.961115)
     hiredis: 10x PING pipeline, 10000 times            0.400000   0.140000   0.540000 (  0.893594)
    redis-rb:  1x SET pipeline, 10000 times             0.380000   0.170000   0.550000 (  0.826631)
     hiredis:  1x SET pipeline, 10000 times             0.190000   0.130000   0.320000 (  0.642933)
    redis-rb: 10x SET pipeline, 10000 times             2.410000   1.000000   3.410000 (  3.424421)
     hiredis: 10x SET pipeline, 10000 times             0.460000   0.150000   0.610000 (  1.103812)
    redis-rb:  1x GET pipeline, 10000 times             0.370000   0.170000   0.540000 (  0.784988)
     hiredis:  1x GET pipeline, 10000 times             0.200000   0.130000   0.330000 (  0.643808)
    redis-rb: 10x GET pipeline, 10000 times             2.400000   1.030000   3.430000 (  3.428278)
     hiredis: 10x GET pipeline, 10000 times             0.430000   0.140000   0.570000 (  0.993723)
    redis-rb:  1x MGET(10) pipeline, 10000 times        1.070000   0.180000   1.250000 (  1.586623)
     hiredis:  1x MGET(10) pipeline, 10000 times        0.250000   0.140000   0.390000 (  0.736734)
    redis-rb: 10x MGET(10) pipeline, 10000 times       10.110000   1.140000  11.250000 ( 11.270423)
     hiredis: 10x MGET(10) pipeline, 10000 times        1.060000   0.160000   1.220000 (  2.208283)

## License

This code is released under the BSD license, after the license of hiredis.
